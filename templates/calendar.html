{% extends 'side_bar.html' %}
{%block head%}
<style>
    * {
        box-sizing: border-box;
    }

    ::-webkit-scrollbar {
        width: 8px;
    }

    ::-webkit-scrollbar-thumb {
        background-color: #fff;
        border-radius: 20px;
    }

    #formulario {
        display: none;
    }

    textarea {
        resize: none;
    }

    .main {
        display: flex;
        height: 95vh;
        justify-content: center;
        align-items: center;
    }

    .container {
        width: 1000px;
        min-height: 520px;
        margin: 0 auto;
        padding: 5px;
        display: flex;
        border-radius: 15px;
        background-color: #5865f2;
    }

    .left {
        width: 50%;
        height: 100%;
        padding: 10px;
        display: flex;
        align-items: center;
    }

    .calendar {
        position: relative;
        width: 100%;
        height: 85%;
        display: flex;
        flex-direction: column;
        flex-wrap: wrap;
        justify-content: center;
        border-radius: 5px;
        background-color: #fff;
    }

    .calendar .month {
        width: 100%;
        height: 90px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 50px;
        font-size: 1.2rem;
        font-weight: 500;
        text-transform: capitalize;
    }

    .calendar .month .prev,
    .calendar .month .next {
        padding: 7px 10px;
        background-color: #eee;
        border: 2px solid #eee;
        border-radius: 15px;
    }

    .calendar .month .prev:hover,
    .calendar .month .next:hover {
        background-color: #fff;
        border: 2px solid #ddd;
        cursor: pointer;
    }

    .calendar .weekdays {
        width: 100%;
        height: 100px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 20px;
        font-size: 1rem;
        font-weight: 500;
        text-transform: capitalize;
    }

    .calendar .weekdays div {
        width: 14.28%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .calendar .days {
        width: 100%;
        display: flex;
        flex-wrap: wrap;
        padding: 0 20px;
        font-size: 1rem;
        font-weight: 500;
        margin-bottom: 20px;
    }

    .calendar .days .day {
        width: 14.28%;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        border-radius: 15px;
        transition: background-color 0.3s;
    }

    .calendar .days .day:hover:not(.today, .active) {
        border: 1px solid #aaa;
        border-radius: 15px;
    }

    .calendar .days .today {
        background-color: #5865f2;
        border-radius: 15px;
        position: relative;
    }

    .calendar .days .active {
        background-color: #fee75c;
        border-radius: 15px;
        position: relative;
    }
    
    .calendar .days .inactive {
        cursor: not-allowed;
        color: #bbb;
    }

    .calendar .days .event {
        position: relative;
    }

    .calendar .days .active::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        box-shadow: 0 0 0 10px 2px #5865f2;
    }

    .calendar .day.event::after {
        content: '';
        position: absolute;
        bottom: 12%;
        left: 50%;
        transform: translateX(-50%);
        width: 60%;
        /* largura da barra */
        height: 6px;
        /* altura da barra */
        background-color: #fee75c;
        /* cor da barra */
        border-radius: 30px;
        
        /* borda arredondada */
    }

    .container .right {
        display:flex;
        position: relative;
        width: 45%;
        min-height: 70%;
        padding-top: 2px;
        padding-left: 30px;
    }

    .right .today-date {
        position: absolute;
        width: 100%;
        height: 100px;
        flex-wrap: wrap;
        text-transform: capitalize;
        align-items: center;
    }

    .today-date .event-day {
        font-size: 2rem;
        font-weight: 500;
        margin-right:200px
    }

    .today-date .event-date {
        font-size: 1.2rem;
        font-weight: 400;
        color: #fee75c;
    }

    .btn-newform {
        height: 30px;
        width: 30px;
        margin-left: 90%;
        margin-top: -20px;
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: #57f287;
        border-radius: 5px;
        position: absolute;
        cursor: pointer;
    }

    .btn-newform:hover {
        background-color: #f0f0f0; /* Mudando a cor de fundo quando o mouse passa sobre o botão */
    }

    .btn-delet {
        height: 30px;
        width: 30px;
        margin-left: 375px;
        margin-top: -25px;
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: #ed4245;
        border-radius: 5px;
        cursor: pointer;
    }

    .modal-form {
        display: none;
        position: fixed;
        z-index: 1;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        transition: opacity 0.3s ease-in-out;
        transform: scale(0.9);
    }

    .modal-delet {
        display: none;
        position: fixed;
        z-index: 1;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        transition: opacity 0.3s ease-in-out;
        transform: scale(0.9);
    }

    .modal-content-form {
        background-color: #ac6cff;
        margin: 7% auto;
        border-radius: 10px;
        padding: 20px;
        border: 1px solid #888;
        width: 21%;
        animation: modal-in 0.3s ease-in-out;
        /* Add animation for modal entrance */
    }

    .modal-content-delet {
        background-color: #ac6cff;
        margin: 7% auto;
        border-radius: 10px;
        padding: 20px;
        border: 1px solid #888;
        width: 21%;
        animation: modal-in 0.3s ease-in-out;
        /* Add animation for modal entrance */
    }

    @keyframes modal-in {
        from {
            opacity: 0;
            transform: scale(0.9);
        }

        to {
            opacity: 1;
            transform: scale(1);
        }
    }

    /* Close button styles */
    .fechar {
        color: black;
        float: right;
        font-size: 28px;
        font-weight: bold;
        margin-top:-10px
    }

    .fechar:hover,
    .fechar:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
    }
</style>
{% endblock %}
{% block content %}
<div class="container">
    <div class="left">
        <div class="calendar">
            <div class="month">
                <i class="fa fa-angle-left prev"></i>
                <div class="date"></div>
                <i class="fa fa-angle-right next"></i>
            </div>
            <div class="weekdays">
                <div>Dom</div>
                <div>Seg</div>
                <div>Ter</div>
                <div>Qua</div>
                <div>Qui</div>
                <div>Sex</div>
                <div>Sáb</div>
            </div>
            <div class="days">
                <div class="day">01</div>
                <div class="day">02</div>
                <div class="day">03</div>
                <div class="day">04</div>
                <div class="day">05</div>
                <div class="day">06</div>
                <div class="day">07</div>
                <div class="day">08</div>
                <div class="day">09</div>
                <div class="day">10</div>
                <div class="day">11</div>
                <div class="day">12</div>
                <div class="day">13</div>
                <div class="day">14</div>
                <div class="day">15</div>
                <div class="day">16</div>
                <div class="day">17</div>
                <div class="day">18</div>
                <div class="day">19</div>
                <div class="day">20</div>
                <div class="day">21</div>
                <div class="day">22</div>
                <div class="day">23</div>
                <div class="day">24</div>
                <div class="day">25</div>
                <div class="day">26</div>
                <div class="day">27</div>
                <div class="day">28</div>
                <div class="day">29</div>
                <div class="day">30</div>
                <div class="day">31</div>
            </div>
        </div>
    </div>
    <div class="right">
        <div class="today-date">
            <div class="event-day"></div>
            <a class="" id="btnModalForm">
                <div class="btn-newform">
                    <i class="fas fa-plus"></i>
                </div>
            </a>
            <div class="event-date" style="margin-right:100px"></div>

            <div id="modalForm" class="modal-form">
                <div class="modal-content-form">
                    <span class="fechar">&times;</span>
                    <h2>
                    <form method="post">
                        {% csrf_token %}
                        {{ form }}
                        <input type="hidden" name="data" id="dataSelecionada">
                        <input type="submit" value="Salvar">
                    </form>
                    </h2>
                </div>
            </div>

            <div id="modalDelet" class="modal-delet">
                <div class="modal-content-delet">
                    <span class="fechar">&times;</span>
                    <h2>
                    
                    </h2>
                </div>
            </div>

            <div id="eventosDaDataSelecionada" style="height:434px; margin-top:8px; margin-right:15px; margin-left:-20px; overflow:auto; overflow-x:hidden;";>
                {% for evento in eventos %}
                <div class="evento"></div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
<script>
    var btnModalForm = document.getElementById("btnModalForm");
    var modalForm = document.getElementById("modalForm");
    var fecharBtn = document.getElementsByClassName("fechar")[0];

    btnModalForm.onclick = function () {
        modalForm.style.display = "block";
    }

    fecharBtn.onclick = function () {
        modalForm.style.display = "none";
    }

    window.onclick = function (event) {
        if (event.target == modalForm) {
            modalForm.style.display = "none";
        }
    }

    document.addEventListener("DOMContentLoaded", function () {

        const prevBtn = document.querySelector('.prev');
        const nextBtn = document.querySelector('.next');
        const dateElement = document.querySelector('.date');
        const daysContainer = document.querySelector('.days');
        const daysOfWeek = ['Domingo', 'Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado'];
        const monthNames = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];

        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();

        renderCalendar(currentMonth, currentYear);

        prevBtn.addEventListener('click', () => {
            if (currentMonth === 0) {
                currentMonth = 11;
                currentYear -= 1;
            } else {
                currentMonth -= 1;
            }
            renderCalendar(currentMonth, currentYear);
        });

        nextBtn.addEventListener('click', () => {
            if (currentMonth === 11) {
                currentMonth = 0;
                currentYear += 1;
            } else {
                currentMonth += 1;
            }
            renderCalendar(currentMonth, currentYear);
        });

        daysContainer.addEventListener('click', (event) => {
            const selectedDay = event.target;
            const activeDay = document.querySelector('.day.active');

            if (selectedDay.classList.contains('day') && !selectedDay.classList.contains('inactive') && !selectedDay.classList.contains('active')) {
                if (activeDay) {
                    activeDay.classList.remove('active');
                }
                selectedDay.classList.add('active');

                // Obter o mês e o ano selecionados
                const monthYear = document.querySelector('.date').textContent.split(' ');
                const selectedMonth = monthYear[0];
                const selectedYear = monthYear[1];

                updateTodayDate(selectedDay.textContent, selectedMonth, selectedYear);
                getSelectedDate(selectedDay.textContent, selectedMonth, selectedYear);
            }
        });

        function updateTodayDate(selectedDate, selectedMonth, selectedYear) {
            // Mapeando o nome do mês para o índice do mês no array monthNames
            const monthIndex = monthNames.indexOf(selectedMonth);

            // Criando a data com o índice do mês corrigido
            const selectDate = new Date(selectedYear, monthIndex, selectedDate);

            // Obtendo o nome do dia da semana da data específica
            const currentDayOfWeekIndex = selectDate.getDay();
            const currentDayOfWeek = daysOfWeek[currentDayOfWeekIndex];

            const eventDayElement = document.querySelector('.event-day');
            const eventDateElement = document.querySelector('.event-date');

            eventDayElement.textContent = `${currentDayOfWeek}`;
            eventDateElement.textContent = `${selectedDate} de ${selectedMonth} de ${selectedYear}`;
        }

        function getSelectedDate(selectedDate, selectedMonth, selectedYear) {
            const monthNumber = monthNames.indexOf(selectedMonth) + 1;
            const formattedDate = `${selectedYear}-${monthNumber.toString().padStart(2, '0')}-${selectedDate.padStart(2, '0')}`;
            document.getElementById('dataSelecionada').value = formattedDate;

            var dataAtiva = $("#dataSelecionada").val();
            $.ajax({
                type: "POST",
                url: "{% url 'calendar' %}",  // Substitua 'url_do_seu_view' pela URL correta do seu view em Django
                data: {
                    'dataAtiva': dataAtiva,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'  // Adicione o token CSRF para proteger contra CSRF attacks
                },

                success: function (response) {
                    // Atualizar eventos com base na resposta do servidor
                    $('#eventosDaDataSelecionada').empty();  // Limpar eventos antigos
                    response.eventos.forEach(function(evento) {
                        $('#eventosDaDataSelecionada').append(`
                        <div class="evento"
                        style=
                        "
                            background-color: #fee75c;
                            width:428px;
                            word-wrap:break-word;
                            margin:8px;
                            padding:8px;
                            padding-left:10px;
                            border-radius:8px;
                        "
                        >
                        <h3>${ evento.titulo }</h3>                        
                        <p>${ evento.descricao }</p>
                        <p>${ evento.hora }
                            <a class="" id="btnModalDelet">
                                <div class="btn-delet" event-id="${ evento.id }" event-title="${ evento.titulo }">
                                    <i class="fas fa-trash"></i>
                                </div>
                            </a>
                        </p>

                        </div>`);
                    });
                },
                error: function (error) {
                    console.error("Erro ao enviar dado para Django:", error);
                }
            });
        }

        function renderCalendar(month, year) {
            const firstDay = new Date(year, month).getDay();
            const lastDay = new Date(year, month + 1, 0).getDate();
            const today = new Date().getDate(); // Dia atual
            const currentMonth = new Date().getMonth(); // Mês atual
            const currentYear = new Date().getFullYear(); // Ano atual
            const daysContainer = document.querySelector('.days');
            const lastMonthLastDay = new Date(year, month, 0).getDate(); // Último dia do mês anterior

            const formattedToday = `${year}-${month+1}-${today}`;
            document.getElementById('dataSelecionada').value = formattedToday;

            dateElement.textContent = `${monthNames[month]} ${year}`;
            daysContainer.innerHTML = '';

            // Adicionar dias do mês anterior
            for (let i = firstDay - 1; i >= 0; i--) {
                const day = document.createElement('div');
                day.classList.add('day', 'inactive');
                day.textContent = lastMonthLastDay - i;
                daysContainer.appendChild(day);
            }

            // Adicionar dias do mês atual
            for (let i = 1; i <= lastDay; i++) {
                const day = document.createElement('div');
                day.classList.add('day');
                day.textContent = i;
                if (i === today && month === currentMonth && year === currentYear) {
                    day.classList.add('today');
                }
                if (hasEvent(year, month, i)) {
                    day.classList.add('event');
                }
                daysContainer.appendChild(day);
            }

            // Adicionar dias do próximo mês
            const remainingDays = 42 - (firstDay + lastDay); // Total de dias - (dias do mês atual + dias do mês anterior)
            for (let i = 1; i <= remainingDays; i++) {
                const day = document.createElement('div');
                day.classList.add('day', 'inactive');
                day.textContent = i;
                daysContainer.appendChild(day);
            }

            const eventDayElement = document.querySelector('.event-day');
            const eventDateElement = document.querySelector('.event-date');           

            const currentDate = new Date(currentYear,currentMonth,today);
            const currentDayOfWeekIndex = currentDate.getDay();
            const currentDayOfWeek = daysOfWeek[currentDayOfWeekIndex];

            eventDayElement.textContent = `${currentDayOfWeek}`;
            eventDateElement.textContent = `${today} de ${monthNames[currentMonth]} de ${currentYear}`;
        }

        function hasEvent(year, month, day) {
            var minhaLista = [];

            {% for day in lista_data_evento %}
                minhaLista.push("{{ day }}");
            {% endfor %}
            
            const eventList = minhaLista; // Atribua os valores da sua lista Django para eventList
            const dateString = `${year}-${month + 1}-${day < 10 ? '0' + day : day}`;
            // Verificar se a data está na lista de eventos ou se está dentro do mês correspondente
            return eventList.includes(dateString) || eventList.some(eventDate => {
                const [eventYear, eventMonth, eventDay] = eventDate.split('-').map(Number);
                return eventYear === year && eventMonth - 1 === month && eventDay === day;
            });
        }
    });

</script>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

{% endblock %}